allprojects {
  group = 'org.ratpack-framework'
  version = rootProject.file("shared-resources/org/ratpackframework/ratpack-version.txt").text.trim()

  apply plugin: 'idea'
  apply plugin: 'eclipse'
}

apply from: "idea/idea.gradle"

subprojects {
  if (project.name.endsWith("-test")) {
    return
  }

  apply plugin: 'groovy'
  apply plugin: 'maven'
  apply from: "${rootDir}/gradle/pom.gradle"
  apply plugin: 'signing'

  repositories {
    mavenCentral()
  }

  sourceSets.main {
    resources {
      srcDir rootProject.file("shared-resources")
    }
  }

  task sourceJar(type: Jar) {
    description 'An archive of the source code for Maven Central'
    classifier 'sources'
    from sourceSets.main.groovy
  }

  task groovydocJar(type: Jar) {
    description 'An archive of the GroovyDocs for Maven Central'
    classifier 'javadoc'
    from groovydoc
  }

  artifacts {
    archives groovydocJar, sourceJar
  }

  signing {
    sign configurations.archives
    required { gradle.taskGraph.hasTask(uploadArchives) }
  }

  install {
    repositories {
      mavenDeployer {
        repository(url: "file://${rootProject.rootDir.absolutePath}/localrepo")
      }
    }
  }

  uploadArchives { task ->
    repositories.mavenDeployer {
      beforeDeployment { deployment ->
        signing.signPom(deployment)
      }
      gradle.taskGraph.whenReady { taskGraph ->
        if (taskGraph.hasTask(task)) {
          repository(url: "https://oss.sonatype.org/service/local/staging/deploy/maven2/") {
            authentication(userName: mavenCentralUsername, password: mavenCentralPassword)
          }
          snapshotRepository(url: "https://oss.sonatype.org/content/repositories/snapshots") {
            authentication(userName: mavenCentralUsername, password: mavenCentralPassword)
          }
        }
      }
    }
  }

  modifyPom {
    project {
      description 'A Micro Web Framework for Groovy'
      url 'https://github.com/ratpack/ratpack'
      licenses {
        license {
          name 'The Apache Software License, Version 2.0'
          url 'http://www.apache.org/licenses/LICENSE-2.0.txt'
          distribution 'repo'
        }
      }
      developers {
        developer {
          id 'tlberglund'
          name 'Tim Berglund'
          email 'tlberglund@gmail.com'
        }
        developer {
          id 'ldaley'
          name 'Luke Daley'
          email 'ld@ldaley.com'
        }
      }
      scm {
        connection 'scm:https://ratpack@github.com/ratpack/ratpack'
        developerConnection 'scm:git@github.com:ratpack/ratpack.git'
        url 'https://github.com/ratpack/ratpack'
      }
    }
  }
}

task wrapper(type: Wrapper) {
  gradleVersion = '1.4'
}
